{% extends 'base.html' %}
{% block title %}Thống kê Sinh viên{% endblock %}

{% block head %}
<style>
    .stats-card {
        text-align: center;
        transition: all 0.3s;
        margin-bottom: 20px;
    }
    .stats-card:hover {
        transform: translateY(-5px);
    }
    .stats-number {
        font-size: 2.5rem;
        font-weight: bold;
    }
    .stats-label {
        font-size: 1rem;
    }
    
    .progress {
        height: 25px;
        margin-bottom: 15px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="mb-0 text-primary fs-4"><i class="fas fa-chart-bar me-2"></i>Thống kê Sinh viên</h3>
        <a href="{{ url_for('students.student_list') }}" class="btn btn-primary">
            <i class="fas fa-arrow-left me-2"></i>Quay lại
        </a>
    </div>
    
    <!-- Thống kê tổng quan -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6">
            <div class="card bg-primary text-white stats-card h-100">
                <div class="card-body">
                    <i class="fas fa-users fa-2x mb-3"></i>
                    <div class="stats-number">{{ total_students }}</div>
                    <div class="stats-label">Tổng sinh viên</div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="card bg-success text-white stats-card h-100">
                <div class="card-body">
                    <i class="fas fa-award fa-2x mb-3"></i>
                    <div class="stats-number">{{ grade_stats.get('Giỏi', 0) }}</div>
                    <div class="stats-label">Sinh viên Giỏi</div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="card bg-info text-white stats-card h-100">
                <div class="card-body">
                    <i class="fas fa-building fa-2x mb-3"></i>
                    <div class="stats-number">
    {% if is_admin %}
        {{ total_classes }}
    {% else %}
        {{ teacher_class_count }}
    {% endif %}
</div>
<div class="stats-label">Số lớp</div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="card bg-warning text-white stats-card h-100">
                <div class="card-body">
                    <i class="fas fa-star fa-2x mb-3"></i>
                    <div class="stats-number">{{ avg_score_total }}</div>
                    <div class="stats-label">Điểm trung bình</div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <!-- Thống kê theo lớp -->
        <div class="col-lg-6 mb-4">
            <div class="card h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Thống kê theo lớp</h5>
                </div>
                <div class="card-body">
                    {% if class_stats %}
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Lớp</th>
                                    <th>Số lượng</th>
                                    <th>Điểm TB</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for class_name, count in class_stats|dictsort(true, 'value') %}
<tr>
    <td>{{ class_name }}</td>
    <td>{{ count }}</td>
    <td>{{ avg_scores_by_class.get(class_name, 0) }}</td>
</tr>
{% endfor %}
                            </tbody>
                        </table>
                    {% else %}
                        <div class="alert alert-info">Không có dữ liệu</div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Thống kê theo giới tính -->
        <div class="col-lg-6 mb-4">
            <div class="card h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Thống kê theo giới tính</h5>
                </div>
                <div class="card-body">
                    {% if gender_stats %}
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Giới tính</th>
                                    <th>Số lượng</th>
                                    <th>Tỷ lệ</th>
                                    <th>Điểm TB</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for gender, count in gender_stats.items() %}
                                <tr>
                                    <td>
                                        {% if gender == 'Nam' %}
                                            <i class="fas fa-male text-primary me-2"></i>
                                        {% elif gender == 'Nữ' %}
                                            <i class="fas fa-female text-danger me-2"></i>
                                        {% else %}
                                            <i class="fas fa-question text-secondary me-2"></i>
                                        {% endif %}
                                        {{ gender }}
                                    </td>
                                    <td>{{ count }}</td>
                                    <td>{{ ((count / total_students * 100)|round|int) if total_students > 0 else 0 }}%</td>
                                    <td>{{ avg_scores_by_gender.get(gender, 0) }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    {% else %}
                        <div class="alert alert-info">Không có dữ liệu</div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <!-- Phân loại điểm -->
        <div class="col-lg-6 mb-4">
            <div class="card h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Phân loại theo điểm</h5>
                </div>
                <div class="card-body">
                    {% if grade_stats %}
    <table class="table table-hover">
        <thead>
            <tr>
                <th>Xếp loại</th>
                <th>Số lượng</th>
                <th>Tỷ lệ</th>
            </tr>
        </thead>
        <tbody>
            {% set grade_order = ['Giỏi', 'Khá', 'Trung bình', 'Yếu', 'Kém', 'Chưa có điểm'] %}
            {% for grade in grade_order %}
                {% if grade_stats.get(grade) is not none %}
                <tr>
                    <td>
                        {% if grade == 'Giỏi' %}
                            <span class="badge bg-success">{{ grade }}</span>
                        {% elif grade == 'Khá' %}
                            <span class="badge bg-primary">{{ grade }}</span>
                        {% elif grade == 'Trung bình' %}
                            <span class="badge bg-info">{{ grade }}</span>
                        {% elif grade == 'Yếu' %}
                            <span class="badge bg-warning">{{ grade }}</span>
                        {% else %}
                            <span class="badge bg-danger">{{ grade }}</span>
                        {% endif %}
                    </td>
                    <td>{{ grade_stats[grade] }}</td>
                    <td>{{ ((grade_stats[grade] / total_students * 100)|round|int) if total_students > 0 else 0 }}%</td>
                </tr>
                {% endif %}
            {% endfor %}
        </tbody>
    </table>
                    {% else %}
                        <div class="alert alert-info">Không có dữ liệu</div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Phân bố điểm -->
        <div class="col-lg-6 mb-4">
            <div class="card h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Phân bố theo khoảng điểm</h5>
                </div>
                <div class="card-body">
                    {% if score_ranges %}
    {% set score_order = ['8.0-10', '7.0-8.5', '5.5-7.0', '4.0-5.5', '0-4.0', 'Chưa có điểm'] %}
    {% for range_name in score_order %}
        {% if score_ranges.get(range_name) is not none %}
        <div class="mb-3">
            <div class="d-flex justify-content-between mb-1">
                <span>{{ range_name }}</span>
                <span>{{ score_ranges[range_name] }} sinh viên ({{ ((score_ranges[range_name] / total_students * 100)|round|int) if total_students > 0 else 0 }}%)</span>
            </div>
            <div class="progress">
                {% set percent = (score_ranges[range_name] / total_students * 100) if total_students > 0 else 0 %}
                {% if range_name == '8.0-10' %}
                    <div class="progress-bar bg-success" data-width="{{ percent }}"></div>
                {% elif range_name == '7.0-8.5' %}
                    <div class="progress-bar bg-primary" data-width="{{ percent }}"></div>
                {% elif range_name == '5.5-7.0' %}
                    <div class="progress-bar bg-info" data-width="{{ percent }}"></div>
                {% elif range_name == '4.0-5.5' %}
                    <div class="progress-bar bg-warning" data-width="{{ percent }}"></div>
                {% else %}
                    <div class="progress-bar bg-danger" data-width="{{ percent }}"></div>
                {% endif %}
            </div>
        </div>
        {% endif %}
    {% endfor %}
                    {% else %}
                        <div class="alert alert-info">Không có dữ liệu</div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Thiết lập width cho các progress bar
    document.addEventListener('DOMContentLoaded', function() {
        const progressBars = document.querySelectorAll('.progress-bar');
        progressBars.forEach(function(bar) {
            const width = bar.getAttribute('data-width');
            bar.style.width = width + '%';
        });
    });
</script>
{% endblock %}